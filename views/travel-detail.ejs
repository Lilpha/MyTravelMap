<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= travel.title %> - MyTravelMap</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=dnehqru9x2"></script>
    <style>
        /* ìºëŸ¬ì…€ ìŠ¤íƒ€ì¼ */
        .carousel-container {
            position: relative;
            width: 200px;
            height: auto;
        }

        .carousel-wrapper {
            overflow: hidden;
            border-radius: 4px;
            background: #f0f0f0;
        }

        .carousel-track {
            display: flex;
            transition: transform 0.3s ease;
        }

        .carousel-slide {
            flex-shrink: 0;
            width: 200px;
        }

        .carousel-slide img,
        .carousel-slide video {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .carousel-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
            gap: 4px;
        }

        .carousel-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            flex: 1;
        }

        .carousel-btn:hover {
            background: #1976D2;
        }

        .carousel-counter {
            font-size: 11px;
            color: #666;
            text-align: center;
            padding: 4px;
            background: #f9f9f9;
            border-radius: 3px;
            min-width: 40px;
        }

        .carousel-info {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
            text-align: center;
            max-width: 200px;
            word-break: break-word;
        }

        /* InfoWindow ìŠ¤íƒ€ì¼ */
        .naver-infowindow {
            pointer-events: auto !important;
        }

        .naver-infowindow-content {
            pointer-events: auto !important;
        }
    </style>
<body>
    <header class="navbar">
        <div class="container">
            <h1>ğŸŒ MyTravelMap</h1>
            <nav>
                <a href="/" class="nav-link">í™ˆ</a>
                <a href="/add" class="nav-link">+ ì—¬í–‰ ì¶”ê°€</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="travel-detail-wrapper">
            <!-- ì™¼ìª½: ì§€ë„ -->
            <section class="detail-map-section">
                <div id="map" style="width: 100%; height: 500px;"></div>
                <% if (travel.latitude && travel.longitude) { %>
                    <div class="coordinates">
                        <p>ğŸ“ <%= travel.latitude.toFixed(4) %>, <%= travel.longitude.toFixed(4) %></p>
                    </div>
                <% } %>
            </section>

            <!-- ì˜¤ë¥¸ìª½: ìƒì„¸ ì •ë³´ -->
            <section class="detail-info-section">
                <div class="detail-header">
                    <h1><%= travel.title %></h1>
                    <a href="/" class="btn btn-secondary">â† ëª©ë¡ìœ¼ë¡œ</a>
                </div>

                <div class="detail-meta">
                    <span class="meta-item">ğŸ“… <%= travel.uploadDate %></span>
                    <% if (travel.tags && travel.tags.length > 0) { %>
                        <div class="tags">
                            <% travel.tags.forEach(tag => { %>
                                <span class="tag">#<%= tag %></span>
                            <% }); %>
                        </div>
                    <% } %>
                </div>

                <div class="detail-description" style="display: none;">
                    <h3>ì„¤ëª…</h3>
                    <p><%= travel.description %></p>
                </div>

                <!-- ë¯¸ë””ì–´ ê°¤ëŸ¬ë¦¬ -->
                <% if (travel.media && travel.media.length > 0) { %>
                    <div class="media-gallery" style="display: none;">
                        <h3>ì‚¬ì§„ & ì˜ìƒ</h3>
                        <div class="gallery-grid">
                            <% travel.media.forEach(file => { %>
                                <div class="gallery-item">
                                    <% if (file.type.startsWith('image/')) { %>
                                        <img src="<%= file.path %>" alt="<%= file.originalName %>" class="gallery-media">
                                    <% } else if (file.type.startsWith('video/')) { %>
                                        <video controls class="gallery-media">
                                            <source src="<%= file.path %>" type="<%= file.type %>">
                                            ë¸Œë¼ìš°ì €ê°€ ì˜ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                        </video>
                                    <% } %>
                                    <p class="file-name"><%= file.originalName %></p>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% } %>

                <div class="detail-actions">
                    <button onclick="deleteTravel('<%= travel.id %>')" class="btn btn-danger">ğŸ—‘ ì‚­ì œ</button>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 MyTravelMap. ëª¨ë“  ì—¬í–‰ì˜ ê¸°ì–µì„ ì§€ë„ì— ë‹´ë‹¤.</p>
    </footer>

    <script>
        // GPS ê¸°ë°˜ ì´ë¯¸ì§€ ê·¸ë£¹í™” (ê±°ë¦¬ ê¸°ì¤€: 0.0005ë„ â‰ˆ 50m)
        const DISTANCE_THRESHOLD = 0.0005;

        function getImageGroups() {
            const media = <%- JSON.stringify(travel.media || []) %>;
            const groups = [];

            console.log('ğŸ“Š ì´ ì´ë¯¸ì§€:', media.length);
            console.log('ğŸ“· ì´ë¯¸ì§€ ë°ì´í„°:', media);

            media.forEach((file, idx) => {
                // GPS ë°ì´í„° ìˆëŠ” ì´ë¯¸ì§€ë§Œ ì²˜ë¦¬
                if (!file.latitude || !file.longitude) {
                    console.warn(`âš ï¸ ${idx}ë²ˆ ì´ë¯¸ì§€: GPS ë°ì´í„° ì—†ìŒ`);
                    return;
                }

                console.log(`âœ“ ${idx}ë²ˆ ì´ë¯¸ì§€: GPS (${file.latitude}, ${file.longitude})`);

                // ê¸°ì¡´ ê·¸ë£¹ ì°¾ê¸°
                const existingGroup = groups.find(group => {
                    const refLat = group[0].latitude;
                    const refLon = group[0].longitude;
                    const latDiff = Math.abs(file.latitude - refLat);
                    const lonDiff = Math.abs(file.longitude - refLon);
                    
                    return latDiff < DISTANCE_THRESHOLD && lonDiff < DISTANCE_THRESHOLD;
                });

                if (existingGroup) {
                    console.log(`â• ${idx}ë²ˆ ì´ë¯¸ì§€ë¥¼ ê¸°ì¡´ ê·¸ë£¹ì— ì¶”ê°€`);
                    existingGroup.push(file);
                } else {
                    console.log(`ğŸ†• ${idx}ë²ˆ ì´ë¯¸ì§€ë¡œ ìƒˆ ê·¸ë£¹ ìƒì„±`);
                    groups.push([file]);
                }
            });

            console.log(`ğŸ“ ì´ ë§ˆì»¤ ê·¸ë£¹: ${groups.length}ê°œ`);
            return groups;
        }

        function createCarouselHTML(imageGroup, groupIdx) {
            let html = `<div class="carousel-container">`;
            html += `<div class="carousel-wrapper">`;
            html += `<div class="carousel-track" id="carousel-${groupIdx}">`;

            imageGroup.forEach((file, idx) => {
                html += `<div class="carousel-slide" id="slide-${groupIdx}-${idx}">`;
                if (file.type && file.type.startsWith('image/')) {
                    html += `<img src="${file.path}" alt="${file.originalName}">`;
                } else if (file.type && file.type.startsWith('video/')) {
                    html += `<video style="width:100%; height:150px; object-fit:cover;"><source src="${file.path}" type="${file.type}"></video>`;
                }
                html += `</div>`;
            });

            html += `</div></div>`;

            // ë„¤ë¹„ê²Œì´ì…˜
            if (imageGroup.length > 1) {
                html += `<div class="carousel-nav">`;
                html += `<button class="carousel-btn" onclick="carouselPrev(${groupIdx})">â† ì´ì „</button>`;
                html += `<div class="carousel-counter"><span id="counter-${groupIdx}">1</span>/${imageGroup.length}</div>`;
                html += `<button class="carousel-btn" onclick="carouselNext(${groupIdx}, ${imageGroup.length})">ë‹¤ìŒ â†’</button>`;
                html += `</div>`;
            }

            // íŒŒì¼ ì •ë³´
            html += `<div class="carousel-info" id="info-${groupIdx}">`;
            html += `${imageGroup[0].originalName}`;
            html += `</div>`;

            return html;
        }

        function carouselNext(groupIdx, maxSlides) {
            const track = document.getElementById(`carousel-${groupIdx}`);
            let currentSlide = track.dataset.currentSlide || 0;
            currentSlide = parseInt(currentSlide) + 1;

            if (currentSlide >= maxSlides) {
                currentSlide = 0;
            }

            track.dataset.currentSlide = currentSlide;
            const offset = currentSlide * -200;
            track.style.transform = `translateX(${offset}px)`;
            
            document.getElementById(`counter-${groupIdx}`).textContent = currentSlide + 1;
            
            // íŒŒì¼ëª… ì—…ë°ì´íŠ¸
            const imageGroup = getImageGroups()[groupIdx];
            document.getElementById(`info-${groupIdx}`).textContent = imageGroup[currentSlide].originalName;
        }

        function carouselPrev(groupIdx) {
            const track = document.getElementById(`carousel-${groupIdx}`);
            let currentSlide = track.dataset.currentSlide || 0;
            currentSlide = parseInt(currentSlide) - 1;

            if (currentSlide < 0) {
                const imageGroup = getImageGroups()[groupIdx];
                currentSlide = imageGroup.length - 1;
            }

            track.dataset.currentSlide = currentSlide;
            const offset = currentSlide * -200;
            track.style.transform = `translateX(${offset}px)`;
            
            document.getElementById(`counter-${groupIdx}`).textContent = currentSlide + 1;
            
            // íŒŒì¼ëª… ì—…ë°ì´íŠ¸
            const imageGroup = getImageGroups()[groupIdx];
            document.getElementById(`info-${groupIdx}`).textContent = imageGroup[currentSlide].originalName;
        }

        // ì§€ë„ ì´ˆê¸°í™”
        const mapDiv = document.getElementById('map');
        const mapOptions = {
            center: new naver.maps.LatLng(<%= travel.latitude || 37.3595704 %>, <%= travel.longitude || 127.105399 %>),
            zoom: <%= travel.latitude && travel.longitude ? 14 : 12 %>
        };
        const map = new naver.maps.Map(mapDiv, mapOptions);

        // ì—¬í–‰ ë©”ì¸ ë§ˆì»¤
        <% if (travel.latitude && travel.longitude) { %>
            const mainMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(<%= travel.latitude %>, <%= travel.longitude %>),
                map: map,
                title: '<%= travel.title %>',
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                    size: new naver.maps.Size(32, 32),
                    scaledSize: new naver.maps.Size(32, 32)
                }
            });

            // ì •ë³´ ìœˆë„ìš°
            const infoWindow = new naver.maps.InfoWindow({
                content: `
                    <div style="padding: 10px; font-weight: bold;">
                        <%= travel.title %>
                    </div>
                `,
                backgroundColor: '#ffffff',
                borderColor: '#4CAF50',
                borderWidth: 2
            });
            infoWindow.open(map, mainMarker);
        <% } %>

        // GPS ê¸°ë°˜ ì´ë¯¸ì§€ ê·¸ë£¹í™”í•˜ì—¬ ë§ˆì»¤ ì¶”ê°€
        const imageGroups = getImageGroups();
        console.log('ğŸ—ºï¸ ì§€ë„ ë§ˆì»¤ ìƒì„± ì‹œì‘...', imageGroups.length, 'ê°œ ê·¸ë£¹');

        let activeInfoWindow = null;
        let mouseOverMarker = false;
        let mouseOverPopup = false;
        let popupCloseTimer = null;

        imageGroups.forEach((group, groupIdx) => {
            const firstImage = group[0];
            
            console.log(`ğŸ“Œ ê·¸ë£¹ ${groupIdx}: ${group.length}ê°œ ì´ë¯¸ì§€, ìœ„ì¹˜(${firstImage.latitude}, ${firstImage.longitude})`);
            
            const groupMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(firstImage.latitude, firstImage.longitude),
                map: map,
                title: `${group.length}ê°œ ì‚¬ì§„`,
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                    size: new naver.maps.Size(24, 24),
                    scaledSize: new naver.maps.Size(24, 24)
                }
            });

            // ìºëŸ¬ì…€ì´ í¬í•¨ëœ ì •ë³´ ìœˆë„ìš°
            const carouselHTML = createCarouselHTML(group, groupIdx);
            const groupInfoWindow = new naver.maps.InfoWindow({
                content: `
                    <div style="padding: 8px; text-align: center;" id="popup-${groupIdx}" class="info-popup">
                        <p style="margin: 0 0 8px 0; font-weight: bold; font-size: 14px;">ğŸ“ ${group.length}ê°œ ì‚¬ì§„</p>
                        ${carouselHTML}
                    </div>
                `,
                backgroundColor: '#ffffff',
                borderColor: '#2196F3',
                borderWidth: 2
            });

            function closePopup() {
                if (!mouseOverMarker && !mouseOverPopup) {
                    groupInfoWindow.close();
                    activeInfoWindow = null;
                }
            }

            // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
            naver.maps.Event.addListener(groupMarker, 'click', function() {
                console.log(`í´ë¦­: ê·¸ë£¹ ${groupIdx}`);
                if (activeInfoWindow && activeInfoWindow !== groupInfoWindow) {
                    activeInfoWindow.close();
                }
                groupInfoWindow.open(map, groupMarker);
                activeInfoWindow = groupInfoWindow;
            });

            // ë§ˆì»¤ ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì •ë³´ í‘œì‹œ
            naver.maps.Event.addListener(groupMarker, 'mouseover', function() {
                console.log(`Hover: ê·¸ë£¹ ${groupIdx}`);
                mouseOverMarker = true;
                clearTimeout(popupCloseTimer);
                
                if (activeInfoWindow && activeInfoWindow !== groupInfoWindow) {
                    activeInfoWindow.close();
                }
                groupInfoWindow.open(map, groupMarker);
                activeInfoWindow = groupInfoWindow;
            });

            // ë§ˆì»¤ ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì‹œ
            naver.maps.Event.addListener(groupMarker, 'mouseout', function() {
                mouseOverMarker = false;
                popupCloseTimer = setTimeout(closePopup, 200);
            });
        });

        // Popupì— ë§ˆìš°ìŠ¤ ì§„ì…í•˜ë©´ ì—´ë¦° ìƒíƒœ ìœ ì§€
        document.addEventListener('mouseover', function(e) {
            if (e.target.closest('.info-popup') || e.target.closest('.naver-infowindow')) {
                mouseOverPopup = true;
                clearTimeout(popupCloseTimer);
            }
        });

        // Popupì—ì„œ ë§ˆìš°ìŠ¤ ë‚˜ê°€ë©´ ë‹«ê¸°
        document.addEventListener('mouseout', function(e) {
            if (e.target.closest('.info-popup') || e.target.closest('.naver-infowindow')) {
                mouseOverPopup = false;
                popupCloseTimer = setTimeout(() => {
                    if (!mouseOverMarker && !mouseOverPopup && activeInfoWindow) {
                        activeInfoWindow.close();
                        activeInfoWindow = null;
                    }
                }, 200);
            }
        });

        // ì‚­ì œ í•¨ìˆ˜
        function deleteTravel(id) {
            if (confirm('ì •ë§ ì´ ì—¬í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch(`/api/travel/${id}`, {
                    method: 'DELETE'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('ì—¬í–‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        window.location.href = '/';
                    }
                })
                .catch(err => alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
            }
        }
    </script>
</body>
</html>
