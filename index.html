<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTravelMap - ì—¬í–‰ ì¼ê¸°ì¥</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=dnehqru9x2"></script>
    <!-- EXIF ë°ì´í„° ì¶”ì¶œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f5f5;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* ì™¼ìª½: ë„¤ì´ë²„ ì§€ë„ */
        .map-section {
            flex: 1;
            position: relative;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ì˜¤ë¥¸ìª½: ì´ë¯¸ì§€ ëª©ë¡ */
        .image-section {
            width: 400px;
            background-color: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .image-section-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background-color: #f9f9f9;
        }

        .image-section-header h2 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #333;
        }

        .upload-btn {
            width: 100%;
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .upload-btn:hover {
            background-color: #45a049;
        }

        #fileInput {
            display: none;
        }

        /* ì´ë¯¸ì§€ ëª©ë¡ ìŠ¤í¬ë¡¤ ì˜ì—­ */
        .image-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .image-item {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background-color: #fff;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .image-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .image-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #e0e0e0;
        }

        .image-info {
            padding: 12px;
            background-color: #fafafa;
        }

        .image-title {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .image-location {
            font-size: 12px;
            color: #0066cc;
            margin-bottom: 5px;
        }

        .image-location.no-location {
            color: #999;
            font-style: italic;
        }

        .gps-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        .gps-badge.detected {
            background-color: #c8e6c9;
            color: #2e7d32;
        }

        .gps-badge.not-detected {
            background-color: #ffccbc;
            color: #d84315;
        }

        .image-item.active {
            border-color: #4CAF50;
            background-color: #f0f8f0;
        }

        /* ë§ˆì»¤ ì •ë³´ íŒì—… */
        .marker-info-popup {
            min-width: 200px;
            padding: 12px;
        }

        .marker-info-popup h3 {
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
        }

        .marker-info-popup p {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .map-section {
                flex: 1;
                height: 50%;
            }

            .image-section {
                width: 100%;
                height: 50%;
                border-left: none;
                border-top: 1px solid #ddd;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ì™¼ìª½: ë„¤ì´ë²„ ì§€ë„ -->
        <div class="map-section">
            <div id="map"></div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì´ë¯¸ì§€ ëª©ë¡ -->
        <div class="image-section">
            <div class="image-section-header">
                <h2>ğŸ“¸ ë‚˜ì˜ ì—¬í–‰</h2>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    + ì´ë¯¸ì§€ ì—…ë¡œë“œ
                </button>
                <input type="file" id="fileInput" accept="image/*" multiple>
            </div>
            <div class="image-list-container" id="imageList">
                <p style="color: #999; text-align: center; margin-top: 40px;">
                    ì•„ì§ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.
                </p>
            </div>
        </div>
    </div>

    <script>
        // ë°ì´í„° ì €ì¥ì†Œ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™œìš©)
        let images = [];
        let markers = [];
        let currentSelectedIndex = -1;

        // piexif ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸°
        function waitForPiexif() {
            return new Promise((resolve) => {
                if (typeof EXIF !== 'undefined') {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (typeof EXIF !== 'undefined') {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                    // ìµœëŒ€ 5ì´ˆ ëŒ€ê¸°
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        resolve();
                    }, 5000);
                }
            });
        }

        // 1. ë„¤ì´ë²„ ì§€ë„ ì´ˆê¸°í™”
        const mapDiv = document.getElementById('map');
        const mapOptions = {
            center: new naver.maps.LatLng(37.3595704, 127.105399), // ì„œìš¸ ê·¸ë¦°íŒ©í† ë¦¬ ê¸°ë³¸ê°’
            zoom: 12
        };

        const map = new naver.maps.Map(mapDiv, mapOptions);

        // 2. íŒŒì¼ ì…ë ¥ ì´ë²¤íŠ¸
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        async function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            
            // piexif ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸°
            await waitForPiexif();
            
            for (const file of files) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // EXIF ë°ì´í„°ì™€ ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° í•¨ê»˜ ì¶”ì¶œ
                        extractImageMetadata(file, e.target.result, img);
                    };
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }

        // EXIF ë°ì´í„°ì—ì„œ GPS ì¢Œí‘œ ì¶”ì¶œ
        function extractGPSFromExif(data) {
            try {
                // EXIF ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
                if (typeof EXIF === 'undefined') {
                    console.warn('âš  EXIF ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    return null;
                }

                const exif = EXIF.getAllTags(data);
                
                if (!exif || !exif.GPSLatitude || !exif.GPSLongitude) {
                    return null;
                }

                // GPS ì¢Œí‘œ ë³€í™˜ (DMS í˜•ì‹ â†’ 10ì§„ìˆ˜ í˜•ì‹)
                const latitude = convertDMSToDecimal(exif.GPSLatitude, exif.GPSLatitudeRef);
                const longitude = convertDMSToDecimal(exif.GPSLongitude, exif.GPSLongitudeRef);

                return { latitude, longitude };
            } catch (e) {
                console.log('EXIF ë°ì´í„° ì½ê¸° ì˜¤ë¥˜:', e);
                return null;
            }
        }

        // DMS (ë„, ë¶„, ì´ˆ) í˜•ì‹ì„ 10ì§„ìˆ˜ë¡œ ë³€í™˜
        function convertDMSToDecimal(dms, ref) {
            if (!dms || !dms[0] || !dms[1] || !dms[2]) {
                return null;
            }

            const degrees = dms[0];
            const minutes = dms[1];
            const seconds = dms[2];

            let decimal = degrees + minutes / 60 + seconds / 3600;

            if (ref === 'S' || ref === 'W') {
                decimal *= -1;
            }

            return decimal;
        }

        // 3. ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (EXIF ë°ì´í„° í¬í•¨)
        function extractImageMetadata(file, dataUrl, img) {
            const imageData = {
                id: Date.now() + Math.random(),
                name: file.name,
                dataUrl: dataUrl,
                uploadDate: new Date().toLocaleString('ko-KR'),
                latitude: null,
                longitude: null,
                description: '',
                hasGPS: false,
                make: ''
            };

            // ì´ë¯¸ì§€ ìš”ì†Œì— EXIF ë°ì´í„° ì½ê¸°
            EXIF.getData(img, function() {
                try {
                    const allMetaData = EXIF.getAllTags(this);
                    console.log('ğŸ“‹ EXIF ë°ì´í„°:', allMetaData);
                    
                    // Make (ì´¬ì˜ ê¸°ê¸°) ì •ë³´
                    if (allMetaData.Make) {
                        imageData.make = allMetaData.Make;
                        console.log(`ğŸ“± ì´¬ì˜ê¸°ê¸°: ${allMetaData.Make}`);
                    }

                    // GPS ë°ì´í„° ì¶”ì¶œ
                    const gpsData = extractGPSFromExif(this);
                    
                    if (gpsData) {
                        imageData.latitude = gpsData.latitude;
                        imageData.longitude = gpsData.longitude;
                        imageData.hasGPS = true;
                        console.log(`âœ“ GPS ì •ë³´ ê°ì§€: (${gpsData.latitude.toFixed(4)}, ${gpsData.longitude.toFixed(4)})`);
                    } else {
                        console.log('â„¹ ì´ ì´ë¯¸ì§€ì—ëŠ” GPS ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('EXIF ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                }

                images.push(imageData);
                addImageToList(imageData, images.length - 1);
                
                // GPS ì •ë³´ê°€ ìˆì„ ë•Œë§Œ ì§€ë„ì— ë§ˆì»¤ ìƒì„±
                if (imageData.hasGPS) {
                    createMapMarker(imageData, images.length - 1);
                }
            });
        }

        // 4. ì´ë¯¸ì§€ë¥¼ ëª©ë¡ì— ì¶”ê°€
        function addImageToList(imageData, index) {
            const listContainer = document.getElementById('imageList');
            
            // ì²˜ìŒ ì´ë¯¸ì§€ ì¶”ê°€ ì‹œ ì•ˆë‚´ í…ìŠ¤íŠ¸ ì œê±°
            if (images.length === 1) {
                listContainer.innerHTML = '';
            }

            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.id = `image-item-${index}`;
            imageItem.innerHTML = `
                <img src="${imageData.dataUrl}" class="image-thumbnail">
                <div class="image-info">
                    <div class="image-title">
                        ${imageData.name}
                        <span class="gps-badge ${imageData.hasGPS ? 'detected' : 'not-detected'}">
                            ${imageData.hasGPS ? 'âœ“ GPS' : 'âœ— GPS'}
                        </span>
                    </div>
                    <div class="image-date">ğŸ“… ${imageData.uploadDate}</div>
                    <div class="image-location ${!imageData.latitude ? 'no-location' : ''}">
                        ğŸ“ ${imageData.latitude ? `${imageData.latitude.toFixed(4)}, ${imageData.longitude.toFixed(4)}` : 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ'}
                    </div>
                </div>
            `;

            imageItem.addEventListener('click', () => selectImage(index));
            listContainer.appendChild(imageItem);
        }

        // 5. ì´ë¯¸ì§€ ì„ íƒ ì‹œ ì§€ë„ ì¤‘ì‹¬ ì´ë™
        function selectImage(index) {
            const imageData = images[index];
            
            // ì´ì „ ì„ íƒ ì œê±°
            if (currentSelectedIndex >= 0) {
                const prevItem = document.getElementById(`image-item-${currentSelectedIndex}`);
                if (prevItem) prevItem.classList.remove('active');
            }

            // í˜„ì¬ ì„ íƒ í‘œì‹œ
            currentSelectedIndex = index;
            const currentItem = document.getElementById(`image-item-${index}`);
            if (currentItem) currentItem.classList.add('active');

            // ìœ„ì¹˜ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì§€ë„ ì¤‘ì‹¬ ì´ë™
            if (imageData.latitude && imageData.longitude) {
                const newPosition = new naver.maps.LatLng(imageData.latitude, imageData.longitude);
                map.setCenter(newPosition);
                map.setZoom(15);

                // í•´ë‹¹ ë§ˆì»¤ë¥¼ ê°•ì¡° í‘œì‹œ
                if (markers[index]) {
                    // ë§ˆì»¤ì— ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° (í•„ìš”ì‹œ)
                    markers[index].marker.openInfoWindow(markers[index].infoWindow);
                }
            }
        }

        // 6. ì§€ë„ì— ë§ˆì»¤ ìƒì„±
        function createMapMarker(imageData, index) {
            // GPS ì •ë³´ê°€ ì—†ìœ¼ë©´ ë§ˆì»¤ ìƒì„± ë¶ˆê°€
            if (!imageData.latitude || !imageData.longitude) {
                console.log('âš  GPS ì •ë³´ê°€ ì—†ì–´ ë§ˆì»¤ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const markerPosition = new naver.maps.LatLng(imageData.latitude, imageData.longitude);
            
            const marker = new naver.maps.Marker({
                position: markerPosition,
                map: map,
                title: imageData.name,
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                    size: new naver.maps.Size(32, 32),
                    scaledSize: new naver.maps.Size(32, 32)
                }
            });

            // ì •ë³´ ìœˆë„ìš° (ë§ˆì»¤ í´ë¦­ ì‹œ í‘œì‹œ)
            const infoWindow = new naver.maps.InfoWindow({
                content: `
                    <div class="marker-info-popup">
                        <h3>${imageData.name}</h3>
                        <p>ğŸ“… ${imageData.uploadDate}</p>
                        <p>ğŸ“ ${imageData.latitude.toFixed(4)}, ${imageData.longitude.toFixed(4)}</p>
                    </div>
                `,
                backgroundColor: '#ffffff',
                borderColor: '#4CAF50',
                borderWidth: 2
            });

            // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
            naver.maps.Event.addListener(marker, 'click', function() {
                selectImage(index);
                infoWindow.open(map, marker);
            });

            // ë§ˆì»¤ì™€ ì •ë³´ ìœˆë„ìš° ì €ì¥
            markers[index] = { marker, infoWindow };
        }

        // ì´ˆê¸° ì§€ë„ ì¤‘ì‹¬ ì„¤ì •
        window.addEventListener('load', function() {
            map.setCenter(new naver.maps.LatLng(37.3595704, 127.105399));
        });
    </script>
</body>
</html>